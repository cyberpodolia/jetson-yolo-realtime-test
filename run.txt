# Jetson runbook (joystick realtime, TensorRT FP16)

## 0) Performance mode on Jetson host
sudo nvpmodel -m 0
sudo jetson_clocks

## 1) Verify ONNX exists
ls -lh /home/kolins/jetson-yolo/artifacts/joystick.onnx

## 2) Build TensorRT engine
cd /home/kolins/jetson-yolo
bash scripts/build_engine.sh

## 3) Quick TensorRT sanity (engine-only benchmark)
/usr/src/tensorrt/bin/trtexec --loadEngine=artifacts/joystick_fp16.engine --warmUp=1000 --duration=10 --streams=1

## 4) Runtime via Docker (recommended)
sudo docker run --rm -it \
  --runtime nvidia --network host --ipc host \
  --device /dev/video0:/dev/video0 \
  -v /home/kolins/jetson-yolo:/workspace \
  -w /workspace \
  nvcr.io/nvidia/l4t-ml:r32.7.1-py3 \
  python3 -m src.app \
    --engine artifacts/joystick_fp16.engine \
    --camera 0 --frames 300 --imgsz 320 \
    --conf 0.6 --iou 0.7 --max-det 10 \
    --tracker csrt --det-interval 3 --track-interval 2 \
    --save-json outputs/metrics_det3.json

## 5) Benchmark matrix det_interval={1,3,5} in Docker
for N in 1 3 5; do
  sudo docker run --rm -it \
    --runtime nvidia --network host --ipc host \
    --device /dev/video0:/dev/video0 \
    -v /home/kolins/jetson-yolo:/workspace \
    -w /workspace \
    nvcr.io/nvidia/l4t-ml:r32.7.1-py3 \
    python3 -m src.app \
      --engine artifacts/joystick_fp16.engine \
      --camera 0 --frames 300 --imgsz 320 \
      --conf 0.6 --iou 0.7 --max-det 10 \
      --tracker csrt --det-interval "$N" --track-interval 2 \
      --save-json "outputs/metrics_det${N}.json"
done

## 6) Optional host benchmark script (requires pycuda on host Python)
bash scripts/bench.sh

## 7) Optional live preview in Docker
# Required for GUI in container:
export DISPLAY=:0
xhost +si:localuser:root

sudo docker run --rm -it \
  --runtime nvidia --network host --ipc host \
  --device /dev/video0:/dev/video0 \
  -e DISPLAY=:0 \
  -e QT_X11_NO_MITSHM=1 \
  -v /tmp/.X11-unix:/tmp/.X11-unix \
  -v /home/kolins/.Xauthority:/root/.Xauthority:ro \
  -v /home/kolins/jetson-yolo:/workspace \
  -w /workspace \
  nvcr.io/nvidia/l4t-ml:r32.7.1-py3 \
  python3 -m src.app \
    --engine artifacts/joystick_fp16.engine \
    --camera 0 --frames 999999 --imgsz 320 \
    --conf 0.6 --iou 0.7 --max-det 10 \
    --tracker csrt --det-interval 3 --track-interval 2 \
    --overlay-alpha 0.2 --preview-skip 2 \
    --show

# Optional: revoke temporary X permission after run
xhost -si:localuser:root

## 8) Captured artifacts
# outputs/tegrastats.log
# outputs/metrics_det1.json
# outputs/metrics_det3.json
# outputs/metrics_det5.json
# outputs/metrics.json
